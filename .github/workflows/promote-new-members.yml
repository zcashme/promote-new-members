name: Promote new members

on:
  schedule:
    - cron: "0 9 * * *"   # 09:00 UTC daily
  workflow_dispatch:
    inputs:
      timestamp_utc:
        description: "Optional override timestamp (ISO8601 UTC). Leave empty to use now."
        required: false
        default: ""

jobs:
  promote:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install supabase python-dotenv requests

      - name: Generate combined daily draft
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_API_KEY: ${{ secrets.SUPABASE_API_KEY }}
        run: |
          TS="${{ github.event.inputs.timestamp_utc }}"
          mkdir -p drafts
          if [ -z "$TS" ]; then
            python scripts/daily_tweet.py
          else
            python scripts/daily_tweet.py --timestamp "$TS"
          fi

      - name: Commit generated drafts
        run: |
          git config user.name "zcashme-bot"
          git config user.email "bot@zcash.me"
          git add drafts/
          git commit -m "Daily combined draft: $(date -u)" || echo "No changes to commit"
          git push

      - name: Create Trello card (combined)
        env:
          TRELLO_KEY: ${{ secrets.TRELLO_KEY }}
          TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
          TRELLO_LIST_ID: ${{ secrets.TRELLO_LIST_ID }}
        run: |
          python .github/scripts/create_trello_card.py drafts/daily_combined.json
